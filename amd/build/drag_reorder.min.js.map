{"version":3,"file":"drag_reorder.min.js","sources":["../src/drag_reorder.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Generic library to allow things in a vertical list to be re-ordered using drag and drop.\n *\n * To make a set of things draggable, create a new instance of this object passing the\n * necessary config, as explained in the comment on the constructor.\n *\n * @package qtype_ordering\n * @copyright 2018 The Open University\n * @license http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\n/**\n * @module qtype_ordering/drag_reorder\n */\ndefine([\n    'jquery',\n    require.specified('core/dragdrop') ? 'core/dragdrop' : 'qtype_ordering/dragdrop',\n    require.specified('core/key_codes') ? 'core/key_codes' : 'qtype_ordering/key_codes'\n], function(\n    $,\n    drag,\n    keys\n) {\n\n    /**\n     * Constructor.\n     *\n     * To make a list draggable, create a new instance of this object, passing the necessary config.\n     * For example:\n     * {\n     *      // Selector for the list (or lists) to be reordered.\n     *      list: 'ul.my-list',\n     *\n     *      // Selector, relative to the list selector, for the items that can be moved.\n     *      item: '> li',\n     *\n     *      // The user actually drags a proxy object, which is constructed from this string,\n     *      // and then added directly as a child of <body>. The token %%ITEM_HTML%% is\n     *      // replaced with the innerHtml of the item being dragged. The token %%ITEM_CLASS_NAME%%\n     *      // is replaced with the class attribute of the item being dragged. Because of this,\n     *      // the styling of the contents of your list item needs to work for the proxy, as well as\n     *      // for items in place in the context of the list. Your CSS also needs to ensure\n     *      // that this proxy has position: absolute. You probably want other styles, like a\n     *      // drop shadow. Using class osep-itemmoving might be all you need to do.\n     *      proxyHtml: '<div class=\"osep-itemmoving %%ITEM_CLASS_NAME%%\">%%ITEM_HTML%%</div>,\n     *\n     *      // While the proxy is being dragged, this class is added to the item being moved.\n     *      // You can probably use \"osep-itemmoving\" here.\n     *      itemMovingClass: \"osep-itemmoving\",\n     *\n     *      // This is a callback which, when called with the DOM node for an item,\n     *      // returns the string that uniquely identifies each item.\n     *      // Therefore, the result of the drag action will be represented by the array\n     *      // obtained by calling this method on each item in the list in order.\n     *      idGetter: function(item) { return $(node).data('id'); },\n     *\n     *      // This is a callback which, when called with the DOM node for an item,\n     *      // returns a string that is the name of the item.\n     *      nameGetter: function(item) { return $(node).text(); },\n     *\n     *      // Function that will be called when a re-order starts (optional, can be not set).\n     *      // Useful if you need to save information about the initial state.\n     *      // This function should have two parameters. The first will be a\n     *      // jQuery object for the list that was reordered, the second will\n     *      // be the jQuery object for the item moved - which will not yet have been moved.\n     *      // Note, it is quite possible for reorderStart to be called with no\n     *      // subsequent call to reorderDone.\n     *      reorderStart: function($list, $item) { ... }\n     *\n     *      // Function that will be called when a drag has finished, and the list\n     *      // has been reordered. This function should have three parameters. The first will be\n     *      // a jQuery object for the list that was reordered, the second will be the jQuery\n     *      // object for the item moved, and the third will be the new order, which is\n     *      // an array of ids obtained by calling idGetter on each item in the list in order.\n     *      // This callback will only be called in the new order is actually different from the old order.\n     *      reorderDone: function($list, $item, newOrder) { ... }\n     *\n     *      // Function that is alwasy called when a re-order ends (optional, can be not set)\n     *      // whether or not the order has changed. Useful if you need to undo changes made\n     *      // in reorderStart, since reorderDone is only called if the new order is different\n     *      // from the original order.\n     *      reorderEnd: function($list, $item) { ... }\n     *  }\n     *\n     * There is a subtlety ( === hack?) that you can use. If you have items in your list that do not\n     * have a drag handle, they they are considered to be placeholders in otherwise empty containers.\n     * See how block_userlinks does it, if this seems like it might be useful. nameGetter should return\n     * the container name for these items.\n     *\n     * @param config As above.\n     */\n    return function(config) {\n        var dragStart = null,       // Information about when and where the drag started.\n            originalOrder = null,   // Array of ids.\n            itemDragging = null,    // Item being moved by dragging (jQuery object).\n            itemMoving = null,      // Item being moved using the accessible modal (jQuery object).\n            proxy = null,           // Drag proxy (jQuery object).\n            orderList = null;       // Order list (jQuery object).\n\n        var startDrag = function(event, details) {\n            orderList = $(config.list);\n\n            dragStart = {\n                time: new Date().getTime(),\n                x: details.x,\n                y: details.y\n            };\n\n            itemDragging = $(event.currentTarget).closest(config.itemInPage);\n\n            if (typeof config.reorderStart !== 'undefined') {\n                config.reorderStart(itemDragging.closest(config.list), itemDragging);\n            }\n\n            originalOrder = getCurrentOrder();\n            proxy = $(config.proxyHtml.replace('%%ITEM_HTML%%', itemDragging.html())\n                .replace('%%ITEM_CLASS_NAME%%', itemDragging.attr('class'))\n                .replace('%%LIST_CLASS_NAME%%', orderList.attr('class')));\n\n            $(document.body).append(proxy);\n            proxy.css('position', 'absolute');\n            proxy.css(itemDragging.offset());\n            proxy.width(itemDragging.outerWidth());\n            proxy.height(itemDragging.outerHeight());\n            itemDragging.addClass(config.itemMovingClass);\n            updateProxy(itemDragging);\n\n            // Start drag.\n            drag.start(event, proxy, dragMove, dragEnd);\n\n        };\n\n        var dragMove = function() {\n            var list = itemDragging.closest(config.list);\n            var closestItem = null;\n            var closestDistance = null;\n            list.find(config.item).each(function (index, element) {\n                var distance = distanceBetweenElements(element, proxy);\n                if (closestItem === null || distance < closestDistance) {\n                    closestItem = $(element);\n                    closestDistance = distance;\n                }\n            });\n\n            if (closestItem[0] === itemDragging[0]) {\n                return;\n            }\n            if (midY(proxy) < midY(closestItem)) {\n                itemDragging.insertBefore(closestItem);\n            } else {\n                itemDragging.insertAfter(closestItem);\n            }\n            updateProxy(itemDragging);\n        };\n\n        /**\n         * Update proxy's position.\n         * @param itemDragging\n         */\n        var updateProxy = function(itemDragging) {\n            var list = itemDragging.closest('ol, ul');\n            var items = list.find('li');\n            var count = items.length;\n            for (var i = 0; i < count; ++i) {\n                //proxy.css('margin-left', '20p');\n                if (itemDragging[0] === items[i]) {\n                    proxy.find('li').attr('value', i + 1);\n                    break;\n                }\n            }\n        };\n\n        /**\n         * It outer and inner are two CSS selectors, which may contain commas,\n         * then combine them safely. So combineSelectors('a, b', 'c, d')\n         * gives 'a c, a d, b c, b d'.\n         * @param outer\n         * @param inner\n         * @returns {string}\n         */\n        var combineSelectors = function(outer, inner) {\n            var combined = [];\n            outer.split(',').forEach(function(firstSelector) {\n                inner.split(',').forEach(function(secondSelector) {\n                    combined.push(firstSelector.trim() + ' ' + secondSelector.trim());\n                });\n            });\n            return combined.join(', ');\n        };\n\n        var dragEnd = function(x, y) {\n            if (typeof config.reorderEnd !== 'undefined') {\n                config.reorderEnd(itemDragging.closest(config.list), itemDragging);\n            }\n\n            var newOrder = getCurrentOrder();\n            if (!arrayEquals(originalOrder, newOrder)) {\n                // Order has changed, call the callback.\n                config.reorderDone(itemDragging.closest(config.list), itemDragging, newOrder);\n\n            } else if (new Date().getTime() - dragStart.time < 500 &&\n                Math.abs(dragStart.x - x) < 10 && Math.abs(dragStart.y - y) < 10) {\n                // This was really a click. Set the focus on the current item.\n                itemDragging[0].focus();\n            }\n            proxy.remove();\n            proxy = null;\n            itemDragging.removeClass(config.itemMovingClass);\n            itemDragging = null;\n            dragStart = null;\n        };\n\n        /**\n         * Items can be moved and placed using certain keys.\n         * Tab for tabbing though and choose the item to be moved\n         * space, arrow-right arrow-down for moving current element forewards.\n         * arrow-right arrow-down for moving the current element backwards.\n         * @param e, the event\n         * @param item, the current moving item\n         */\n        var itemMovedByKeyboard = function (e, current) {\n            switch (e.keyCode) {\n                case keys.space:\n                case keys.arrowRight:\n                case keys.arrowDown:\n                    e.preventDefault();\n                    e.stopPropagation();\n                    var next = current.next();\n                    if (next.length) {\n                        next.insertBefore(current);\n                    }\n                    break;\n\n                case keys.arrowLeft:\n                case keys.arrowUp:\n                    e.preventDefault();\n                    e.stopPropagation();\n                    var prev = current.prev();\n                    if (prev.length) {\n                        prev.insertAfter(current);\n                    }\n                    break;\n            }\n        };\n\n        /**\n         * Get the x-position of the middle of the DOM node represented by the given jQuery object.\n         * @param jQuery wrapping a DOM node.\n         * @returns Number the x-coordinate of the middle (left plus half outerWidth).\n         */\n        var midX = function(jQuery) {\n            return jQuery.offset().left + jQuery.outerWidth() / 2;\n        };\n\n        /**\n         * Get the y-position of the middle of the DOM node represented by the given jQuery object.\n         * @param jQuery wrapping a DOM node.\n         * @returns Number the y-coordinate of the middle (top plus half outerHeight).\n         */\n        var midY = function(jQuery) {\n            return jQuery.offset().top + jQuery.outerHeight() / 2;\n        };\n\n        /**\n         * Calculate the distance between the centres of two elements.\n         * @param element1 selector, element or jQuery.\n         * @param element2 selector, element or jQuery.\n         * @return number the distance in pixels.\n         */\n        var distanceBetweenElements = function(element1, element2) {\n            var e1 = $(element1), e2 = $(element2);\n            var dx = midX(e1) - midX(e2);\n            var dy = midY(e1) - midY(e2);\n            return Math.sqrt(dx * dx + dy * dy);\n        };\n\n        /**\n         * Get the current order of the list containing itemDragging.\n         * @returns Array of strings, the id of each element in order.\n         */\n        var getCurrentOrder = function() {\n            return (itemDragging || itemMoving).closest(config.list).find(config.item).map(\n                    function(index, item) { return config.idGetter(item); }).get();\n        };\n\n        /**\n         * Compare two arrays, which just contain simple values like ints or strings,\n         * to see if they are equal.\n         * @param a1 first array.\n         * @param a2 second array.\n         * @return boolean true if they both contain the same elements in the same order, else false.\n         */\n        var arrayEquals = function(a1, a2) {\n            return a1.length === a2.length &&\n                a1.every(function(v, i) { return v === a2[i]; });\n        };\n        config.itemInPage = combineSelectors(config.list, config.item);\n\n        // AJAX for section drag and click-to-move.\n        $(config.list).on('mousedown touchstart', config.item, function(event) {\n            var details = drag.prepare(event);\n            if (details.start) {\n                startDrag(event, details);\n            }\n        });\n\n        $(config.list).on('keydown', config.item, function(event) {\n            itemMoving = $(event.currentTarget).closest(config.itemInPage);\n            originalOrder = getCurrentOrder();\n            itemMovedByKeyboard(event, itemMoving);\n            var newOrder = getCurrentOrder();\n            if (!arrayEquals(originalOrder, newOrder)) {\n                // Order has changed, call the callback.\n                config.reorderDone(itemMoving.closest(config.list), itemMoving, newOrder);\n            }\n        });\n\n        // Make the items tabbable.\n        $(config.itemInPage).attr('tabindex', '0');\n    };\n});\n"],"names":["define","require","specified","$","drag","keys","config","outer","inner","combined","dragStart","originalOrder","itemDragging","itemMoving","proxy","orderList","dragMove","list","closest","closestItem","closestDistance","find","item","each","index","element","distance","distanceBetweenElements","midY","insertBefore","insertAfter","updateProxy","items","count","length","i","attr","dragEnd","x","y","reorderEnd","newOrder","getCurrentOrder","arrayEquals","Date","getTime","time","Math","abs","focus","reorderDone","remove","removeClass","itemMovingClass","midX","jQuery","offset","left","outerWidth","top","outerHeight","element1","element2","e1","e2","dx","dy","sqrt","map","idGetter","get","a1","a2","every","v","itemInPage","split","forEach","firstSelector","secondSelector","push","trim","join","on","event","details","prepare","start","currentTarget","reorderStart","proxyHtml","replace","html","document","body","append","css","width","height","addClass","startDrag","e","current","keyCode","space","arrowRight","arrowDown","preventDefault","stopPropagation","next","arrowLeft","arrowUp","prev","itemMovedByKeyboard"],"mappings":"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"}